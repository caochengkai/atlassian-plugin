#requireResource("com.atlassian.jira.gadgets:common")
#requireResource("com.atlassian.tutorial.dianrong.plugin:dianrong.plugin-resources")
#includeResources()

<script type="text/javascript" charset="utf-8">

    AJS.Gadget({
        baseUrl: "__ATLASSIAN_BASE_URL__",
        useOauth: "/rest/gadget/1.0/currentUser",
        config: {
            descriptor: function () {
                var gadget = this;
                var searchParam;
                if (/^jql-/.test(gadget.getPref('projectOrFilterId')) || gadget.getPref('isPopup') === "true") {
                    searchParam = {
                        userpref: "projectOrFilterId",
                        type: "hidden",
                        value: gadgets.util.unescapeString(gadget.getPref("projectOrFilterId"))
                    };
                } else {
                    searchParam = AJS.gadget.fields.projectOrFilterPicker(gadget, "projectOrFilterId");
                }
                return {
                    action: "/rest/dianrong-gadget/1.0/planned-vs-released-chart/validate",
                    theme: function () {
                        if (gadgets.window.getViewportDimensions().width < 450) {
                            return "gdt top-label";
                        } else {
                            return "gdt";
                        }
                    }(),
                    fields: [searchParam, {
                        userpref: "period",
                        label: gadget.getMsg("gadget.planned.vs.released.chart.period.label"),
                        description: gadget.getMsg("gadget.planned.vs.released.chart.period.description"),
                        type: "select",
                        selected: gadget.getPref('period'),
                        options: [{
                            label: "Released Version",
                            value: "releasedVersion"
                        }]
                    }, {
                        userpref: "previous",
                        label: gadget.getMsg("gadget.planned.vs.released.chart.previous.label"),
                        description: gadget.getMsg("gadget.planned.vs.released.chart.previous.description"),
                        type: "text",
                        value: gadget.getPref('previous')
                    }, AJS.gadget.fields.nowConfigured()]
                };
            }
        },
        view: {
            enableReload: true, onResizeReload: true, onResizeAdjustHeight: true, template: function (args) {
                var gadget = this;

                var randomScalingFactor = function(){ return Math.round(Math.random()*100)};
                var lineChartData = {
                    labels : ["January","February","March","April","May","June","July"],
                    datasets : [
                        {
                            label: "My First dataset",
                            fillColor : "rgba(220,220,220,0.2)",
                            strokeColor : "rgba(220,220,220,1)",
                            pointColor : "rgba(220,220,220,1)",
                            pointStrokeColor : "#fff",
                            pointHighlightFill : "#fff",
                            pointHighlightStroke : "rgba(220,220,220,1)",
                            data : [randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor()]
                        },
                        {
                            label: "My Second dataset",
                            fillColor : "rgba(151,187,205,0.2)",
                            strokeColor : "rgba(151,187,205,1)",
                            pointColor : "rgba(151,187,205,1)",
                            pointStrokeColor : "#fff",
                            pointHighlightFill : "#fff",
                            pointHighlightStroke : "rgba(151,187,205,1)",
                            data : [randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor(),randomScalingFactor()]
                        }
                    ]

                }

                gadget.getView().html('<canvas id="canvas"></canvas>');
                var ctx=AJS.$('#canvas')[0].getContext('2d');
                var chart =new Chart(ctx).Line(lineChartData, {
                    responsive: true
                });

            }, args: [{
                key: "chart", ajaxOptions: function () {
                    var gadget = this;
                        return {
                            url: "/rest/dianrong-gadget/1.0/planned-vs-released-chart/generate",
                            data: {
                                projectOrFilterId: gadgets.util.unescapeString(gadget.getPref('projectOrFilterId')),
                                period: gadget.getPref('period'),
                                previous: gadget.getPref('previous')
                            }
                        };
                }
            }],
            callback:function () {
                alert(1)
            }
        }
    });


</script>